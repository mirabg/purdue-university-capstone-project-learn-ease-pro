/**
 * Phase 2: Core Course Features - Course Browsing
 * Tests course listing, search, filtering, and navigation
 *
 * STATUS: IMPLEMENTED âœ…
 */

describe("Course Browsing", () => {
  beforeEach(() => {
    cy.clearAppState();
    cy.loginAsStudent();
    
    // Mock enrollments API - needed for all tests
    cy.intercept("GET", "**/api/enrollments*", {
      statusCode: 200,
      body: {
        success: true,
        data: [],
      },
    }).as("enrollmentsApi");
  });

  describe("Course Listing", () => {
    it("should display the explore courses page with header", () => {
      // Mock courses API
      cy.intercept("GET", "**/api/courses*", {
        statusCode: 200,
        body: {
          success: true,
          data: [
            {
              _id: "course1",
              courseCode: "CS101",
              name: "Introduction to Programming",
              description: "Learn the basics of programming",
              instructor: {
                firstName: "John",
                lastName: "Doe",
              },
              credits: 3,
              averageRating: 4.5,
              ratingCount: 10,
            },
          ],
          count: 1,
        },
      }).as("coursesApi");

      cy.visit("/student/explore-courses");
      cy.wait("@coursesApi");

      // Check page header
      cy.contains("h1", "Explore Courses").should("be.visible");
      cy.contains("Browse and enroll in available courses").should(
        "be.visible"
      );

      // Check back button
      cy.contains("button", "Back to Dashboard").should("be.visible");
    });

    it("should display all available courses in a table (desktop view)", () => {
      cy.intercept("GET", "**/api/courses*", {
        statusCode: 200,
        body: {
          success: true,
          data: [
            {
              _id: "course1",
              courseCode: "CS101",
              name: "Introduction to Programming",
              description: "Learn the basics of programming",
              instructor: {
                firstName: "John",
                lastName: "Doe",
              },
              credits: 3,
              averageRating: 4.5,
              ratingCount: 10,
            },
            {
              _id: "course2",
              courseCode: "CS201",
              name: "Data Structures",
              description: "Advanced data structures and algorithms",
              instructor: {
                firstName: "Jane",
                lastName: "Smith",
              },
              credits: 4,
              averageRating: 4.8,
              ratingCount: 15,
            },
          ],
          count: 2,
        },
      }).as("coursesApi");

      cy.viewport(1280, 720); // Desktop viewport
      cy.visit("/student/explore-courses");
      cy.wait("@coursesApi");

      // Check table headers (desktop only)
      cy.contains("th", "Course Code").should("be.visible");
      cy.contains("th", "Course Name").should("be.visible");
      cy.contains("th", "Instructor").should("be.visible");

      // Check first course details
      cy.contains("td", "CS101").should("be.visible");
      cy.contains("td", "Introduction to Programming").should("be.visible");
      cy.contains("td", "John Doe").should("be.visible");

      // Check second course details
      cy.contains("td", "CS201").should("be.visible");
      cy.contains("td", "Data Structures").should("be.visible");
      cy.contains("td", "Jane Smith").should("be.visible");

      // Check enroll buttons
      cy.contains("button", "Enroll").should("have.length.at.least", 2);
    });

    it("should handle empty course list", () => {
      cy.intercept("GET", "**/api/courses*", {
        statusCode: 200,
        body: {
          success: true,
          data: [],
          count: 0,
        },
      }).as("coursesApi");

      cy.visit("/student/explore-courses");
      cy.wait("@coursesApi");

      // Check empty state message
      cy.contains("No courses available at this time").should("be.visible");
    });
  });

  describe("Course Search", () => {
    it("should have a visible search input", () => {
      cy.intercept("GET", "**/api/courses*", {
        statusCode: 200,
        body: { success: true, data: [], count: 0 },
      }).as("coursesApi");

      cy.visit("/student/explore-courses");
      cy.wait("@coursesApi");

      cy.get('input[placeholder="Search courses..."]')
        .should("be.visible")
        .and("have.value", "");
    });
  });

  describe("Course Navigation", () => {
    it("should navigate back to dashboard", () => {
      cy.intercept("GET", "**/api/courses*", {
        statusCode: 200,
        body: { success: true, data: [], count: 0 },
      }).as("coursesApi");

      cy.visit("/student/explore-courses");
      cy.wait("@coursesApi");

      cy.contains("button", "Back to Dashboard").click();
      cy.url().should("include", "/student/dashboard");
    });
  });

  describe("Error Handling", () => {
    it("should display error message when courses fail to load", () => {
      cy.intercept("GET", "**/api/courses*", {
        statusCode: 500,
        body: {
          success: false,
          message: "Failed to load courses",
        },
      }).as("coursesApiError");

      cy.visit("/student/explore-courses");
      cy.wait("@coursesApiError");

      // Should show error message
      cy.contains("Failed to load courses").should("be.visible");
    });
  });
});
